<?php
// auto-generated by sfDoctrineAdmin
// date: 2013/02/15 16:31:24
?>
<?php

/**
 * reservation actions.
 *
 * @package    sf_sandbox
 * @subpackage reservation
 * @author     Fabien Potencier <fabien.potencier@symfony-project.com>
 * @author     Olivier Verdier <Olivier.Verdier@gmail.com>
 * @version    SVN: $Id: actions.class.php 5639 2007-10-23 14:27:18Z Eric.Fredj $
 */
class reservationActions extends autoreservationActions{
    
    public function validateHideInput (){
        return false;
    }


    protected function addFiltersCriteria($q){
        parent::addFiltersCriteria($q);
        
        if(isset($this->filters['email']) && $this->filters['email'] !== ''){
            
            $this->filters['email'] = preg_replace('/[^\w@\-\.]+/i', '', 
                $this->filters['email']);

            $q->addWhere("HotelsReservation.HotelsClient.email like ?", 
                array("%{$this->filters['email']}%"));
        }
        
        if (isset($this->filters['client_name']) && $this->filters['client_name'] !== ''){
        
            $this->filters['client_name'] = preg_replace('/[ ]+/i', ' ', 
                trim($this->filters['client_name']));
            $this->filters['client_name'] = preg_replace('/[^\w ]+/i', '', 
                $this->filters['client_name']);

            $q->innerJoin("HotelsReservation.HotelsClient c");
            $q->addWhere("c.first_name like ? OR c.last_name like ?",  
                array("%{$this->filters['client_name']}%", "%{$this->filters['client_name']}%"));
        }
    }
    
    protected function updateHotelsReservationFromRequest(){
        
        //validate client id and email
        
        $client_email = filter_var($this->getRequestParameter('client_email'), 
            FILTER_VALIDATE_EMAIL);
        $client_id = (int) $this->getRequestParameter('hotels_reservation[client_id]');
        
        //check if client exist with specified parameters
        
        $client = Doctrine_Manager::connection()
            ->fetchOne('SELECT id FROM hotels_client WHERE email = ? AND id = ?'
                , array($client_email, $client_id));

        if($client === false){
            $this->setFlash('warning', 'No such client with specified e-mail');
            $this->redirect('reservation/edit?id=' . $this->getRequestParameter('id'));
        }
        if(isset($client_id)){
            $this->hotels_reservation->set('client_id', $client_id);
        }
        
        //set the room id
        
        $room_id = $this->getRequestParameter('hotels_reservation[room_id]');
        
        if(isset($room_id)){
            $this->hotels_reservation->set('room_id', $room_id);
        }
        
        //calculate full cost of booking
        
        $days = round((
            strtotime($this
                ->getRequestParameter('hotels_reservation[reserved_to]')) 
            - strtotime($this
                ->getRequestParameter('hotels_reservation[reserved_from]'))) / 86400);
        
        $price = Doctrine_Manager::connection()
            ->fetchOne('SELECT price FROM hotels_room WHERE id = ?', array($room_id));
        
        if(!empty($days) && $price){
            $this->hotels_reservation->set('total', $price * $days);
        }

        parent::updateHotelsReservationFromRequest();
    }
    
    public function executeShow(){
        $reservation_id = (int) $this->getRequestParameter('id', 0);
        
        if(empty($reservation_id)){
            $this->setFlash('warning', 'Invalid reservation id');
            $this->redirect('reservation');
        }
        
        $this->hotels_reservation = Doctrine::getTable('HotelsReservation')->find($reservation_id);
        
        if(empty($this->hotels_reservation)){
            $this->setFlash('warning', 'Reservation with such id not exist');
            $this->redirect('reservation');
        }
    }
}
